From c0157162e6b893e9f4830dd1779d37107b455f17 Mon Sep 17 00:00:00 2001
From: Chris Burr <christopher.burr@cern.ch>
Date: Wed, 12 Mar 2025 09:47:43 +0100
Subject: [PATCH 8/8] Only generate modules.idx when not cross-compiling

---
 CMakeLists.txt | 38 +++++++++++++++++++++-----------------
 1 file changed, 21 insertions(+), 17 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 9e2ccc63f6..36fcfd65c7 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -503,25 +503,29 @@ endif()
 
 # modules.idx
 if(runtime_cxxmodules)
-  ROOT_GET_LIBRARY_OUTPUT_DIR(library_output_dir)
-  get_property(modules_idx_deps GLOBAL PROPERTY modules_idx_deps_property)
-  if(WIN32)
-    set(modules_idx_cmd COMMAND ${CMAKE_COMMAND} -E env PATH="${library_output_dir}\\\;%PATH%"
-                                ROOTIGNOREPREFIX=1 ROOT_HIST=0 $<TARGET_FILE:root.exe> -l -q -b)
+  if(CMAKE_CROSSCOMPILING)
+    message(WARNING "Cross-compiling: modules.idx will not be generated")
   else()
-    set(modules_idx_cmd COMMAND ${ld_library_path}=${library_output_dir}:$ENV{${ld_library_path}}
-                                ROOTIGNOREPREFIX=1 ROOT_HIST=0 $<TARGET_FILE:root.exe> -l -q -b)
+    ROOT_GET_LIBRARY_OUTPUT_DIR(library_output_dir)
+    get_property(modules_idx_deps GLOBAL PROPERTY modules_idx_deps_property)
+    if(WIN32)
+      set(modules_idx_cmd COMMAND ${CMAKE_COMMAND} -E env PATH="${library_output_dir}\\\;%PATH%"
+                                  ROOTIGNOREPREFIX=1 ROOT_HIST=0 $<TARGET_FILE:root.exe> -l -q -b)
+    else()
+      set(modules_idx_cmd COMMAND ${ld_library_path}=${library_output_dir}:$ENV{${ld_library_path}}
+                                  ROOTIGNOREPREFIX=1 ROOT_HIST=0 $<TARGET_FILE:root.exe> -l -q -b)
+    endif()
+    add_custom_command(OUTPUT ${library_output_dir}/modules.idx
+                      COMMAND ${CMAKE_COMMAND} -E remove -f modules.idx modules.timestamp
+                      ${modules_idx_cmd}
+                      WORKING_DIRECTORY ${library_output_dir}
+                      DEPENDS $<TARGET_FILE:root.exe> Cling Hist Tree Gpad Graf HistPainter move_artifacts
+                              ${modules_idx_deps})
+    add_custom_target(modules_idx ALL DEPENDS ${library_output_dir}/modules.idx)
+    add_dependencies(modules_idx ${modules_idx_deps})
+    set_property(TARGET modules_idx PROPERTY modules_idx_file ${library_output_dir}/modules.idx)
+    set_directory_properties(PROPERTIES ADDITIONAL_CLEAN_FILES "${library_output_dir}/modules.timestamp")
   endif()
-  add_custom_command(OUTPUT ${library_output_dir}/modules.idx
-                     COMMAND ${CMAKE_COMMAND} -E remove -f modules.idx modules.timestamp
-                     ${modules_idx_cmd}
-                     WORKING_DIRECTORY ${library_output_dir}
-                     DEPENDS $<TARGET_FILE:root.exe> Cling Hist Tree Gpad Graf HistPainter move_artifacts
-                             ${modules_idx_deps})
-  add_custom_target(modules_idx ALL DEPENDS ${library_output_dir}/modules.idx)
-  add_dependencies(modules_idx ${modules_idx_deps})
-  set_property(TARGET modules_idx PROPERTY modules_idx_file ${library_output_dir}/modules.idx)
-  set_directory_properties(PROPERTIES ADDITIONAL_CLEAN_FILES "${library_output_dir}/modules.timestamp")
 endif()
 
 #---hsimple.root---------(use the executable for clearer dependencies and proper return code)---
-- 
2.45.0

